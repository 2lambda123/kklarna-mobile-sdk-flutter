<!DOCTYPE html>
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-type"/>
    <script src="https://x.klarnacdn.net/postpurchaseexperience/lib/v1/api.js"></script>
    <script>
    window.ppe = null;

    window.log = function(msg) {
        console.log("PPE: " + msg);
    }

    window.initialize = function(locale, purchaseCountry, design) {
        log('initialize');
        try {
            var instance = new Klarna.PostPurchaseExperience.init({
                locale: locale,
                purchase_country: purchaseCountry,
                design: design
            });
            ppe = instance;
            nativeCallback('onInitialize', null);
        } catch(error){
            log('initialize exception: ' + error.message);
            nativeCallback('onInitialize', error.message);
        }
    }

    window.renderOperation = function(locale, operationToken) {
        log('renderOperation');
        try{
            ppe.renderOperation({
                locale: locale,
                operation_token: operationToken
            }, function (error, data) {
                var result = {
                    data: JSON.stringify(data),
                    error: JSON.stringify(error)
                };
                nativeCallback('onRenderOperation', JSON.stringify(result));
            });
        } catch(error) {
            log('renderOperation exception: ' + error.message);
            var result = {
                data: null,
                error: error.message
            };
            nativeCallback('onRenderOperation', JSON.stringify(result));
        }
    }


    window.authorizationRequest = function(locale, clientId, scope, redirectUri, state, loginHint, responseType) {
        log('authorizationRequest');
        try {
            var error = ppe.authorizationRequest({
                locale: locale,
                client_id: clientId,
                scope: scope,
                redirect_uri: redirectUri,
                state: state,
                login_hint: loginHint,
                response_type: responseType
            });
            nativeCallback('onAuthorizationRequest', JSON.stringify(error));
        } catch(error){
            log('authorizationRequest exception: ' + error.message);
            nativeCallback('onAuthorizationRequest', error.message);
        }
    }

    window.nativeCallback = function(action, message) {
        let result = {
            action: action,
            message: message
        };

        if (window.webkit &&
            window.webkit.messageHandlers &&
            window.webkit.messageHandlers.PPECallback) {
            window.webkit.messageHandlers.PPECallback.postMessage(JSON.stringify(result));
        } else if (window.PPECallback) {
            window.PPECallback.postMessage(JSON.stringify(result));
        }
    }

    log("PPE HTML loaded.");



    </script>
</head>
<body></body>
</html>
